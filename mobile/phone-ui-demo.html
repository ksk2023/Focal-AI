<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focal - æ‰‹æœºUIæ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* æ‰‹æœºå¤–æ¡† */
        .phone-container {
            width: 390px;
            height: 844px;
            background: #1a1a1a;
            border-radius: 50px;
            padding: 12px;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
        }

        /* åˆ˜æµ· */
        .phone-notch {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 30px;
            background: #1a1a1a;
            border-radius: 0 0 20px 20px;
            z-index: 1000;
        }

        /* Appå†…å®¹åŒº */
        .app {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(20, 20, 20, 0.98);
            backdrop-filter: blur(30px);
            padding: 40px 20px 20px;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            max-height: 80%;
            overflow-y: auto;
        }

        .settings-panel.active {
            transform: translateY(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .settings-item {
            margin-bottom: 16px;
        }

        .settings-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 8px;
            display: block;
        }

        .settings-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .toggle-text {
            color: #fff;
            font-size: 13px;
        }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #34c759;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* è®¾ç½®é¡¹æŒ‰é’®ç»„ */
        .settings-button-group {
            display: flex;
            gap: 12px;
        }

        /* æ¯”ä¾‹é€‰æ‹©å™¨æ ·å¼ - ä»¿ç…§å‚è€ƒå›¾è®¾è®¡ */
        .ratio-button-group {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            padding: 2px;
            width: 100%;
        }

        .ratio-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .ratio-btn.active {
            background: #FFD60A;
            color: #000;
        }

        .settings-btn {
            flex: 1;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn.active {
            background: #ffd60a;
            color: #000;
        }

        /* é£æ ¼åº“æ ·å¼ */
        .style-upload-area {
            margin-top: 10px;
        }

        .style-thumbnails {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .style-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .upload-btn {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .upload-btn input {
            display: none;
        }

        .style-status {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            height: 7.5%;
            min-height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
            position: relative;
            z-index: 10;
        }

        /* AIå›¾æ ‡ï¼ˆå·¦ä¸Šè§’ï¼‰ */
        .ai-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .ai-icon.active {
            background: linear-gradient(135deg, #ffd60a 0%, #ff9500 100%);
            transform: scale(1.1);
        }

        .ai-icon.is-listening {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 214, 10, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 214, 10, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 214, 10, 0);
            }
        }

        /* ç®€çº¦è®¾ç½®æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ */
        .settings-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-icon:active {
            transform: scale(0.85);
            opacity: 0.6;
        }

        /* å§¿åŠ¿å¼•å¯¼å›¾å±‚ */
        .pose-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .pose-overlay.active {
            opacity: 0.8;
            animation: breathe 3s infinite ease-in-out;
        }

        .pose-path {
            fill: none;
            stroke: rgba(255, 255, 255, 0.8);
            stroke-width: 2;
            stroke-dasharray: 10 5;
            stroke-linecap: round;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }

        @keyframes breathe {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 0.9;
            }
        }

        /* ç®­å¤´å¼•å¯¼å›¾å±‚ */
        .arrow-overlay {
            position: absolute;
            top: 20%;
            left: 50%;
            width: 120px;
            height: 120px;
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 15;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .arrow-overlay.active {
            opacity: 1;
            animation: bounce 1.5s infinite;
        }

        .arrow-path {
            fill: #ffd60a;
            stroke: #000;
            stroke-width: 1;
            filter: drop-shadow(0 0 8px rgba(255, 214, 10, 0.6));
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(-15px);
            }
        }

        /* å˜ç„¦æ§åˆ¶æŒ‰é’® */
        .zoom-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: #ffd60a;
            transform: scale(1.1);
            font-weight: 800;
        }

        /* å–æ™¯å™¨ - å 85% */
        .viewfinder {
            height: 85%;
            position: relative;
            background: #000;
            margin: 0 10px;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ¯”ä¾‹é®ç½© */
        .viewfinder::before,
        .viewfinder::after {
            content: '';
            position: absolute;
            left: 0;
            width: 100%;
            background: #000;
            z-index: 4;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .viewfinder::before {
            top: 0;
        }

        .viewfinder::after {
            bottom: 0;
        }

        .viewfinder[data-ratio="1:1"]::before,
        .viewfinder[data-ratio="1:1"]::after {
            height: calc((100% - 75%) / 2 + 10%);
        }

        .viewfinder[data-ratio="4:3"]::before,
        .viewfinder[data-ratio="4:3"]::after {
            height: calc((100% - 90%) / 2 + 3%);
        }

        .viewfinder[data-ratio="16:9"]::before,
        .viewfinder[data-ratio="16:9"]::after {
            height: calc((100% - 65%) / 2 + 15%);
        }

        .viewfinder[data-ratio="full"]::before,
        .viewfinder[data-ratio="full"]::after {
            height: 0;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .feedback {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            padding: 14px 28px;
            border-radius: 16px;
            color: #fff;
            font-size: 15px;
            text-align: center;
            white-space: nowrap;
            max-width: calc(100% - 40px);
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .feedback.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* åº•éƒ¨æ  */
        /* ä¹å®«æ ¼æ ·å¼ */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 5;
        }

        .grid-overlay.active {
            opacity: 1;
        }

        .grid-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        .grid-line.horizontal {
            width: 100%;
            height: 1px;
            left: 0;
        }

        .grid-line.vertical {
            height: 100%;
            width: 1px;
            top: 0;
        }

        .bottom-bar {
            height: 7.5%;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 60px;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #000;
            border: 3px solid #fff;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .capture-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: 4px solid #ffd60a;
        }

        .capture-btn:active {
            transform: scale(0.9);
        }

        .capture-btn:active::before {
            border-width: 5px;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        /* å“åº”å¼ï¼šç§»åŠ¨ç«¯ç›´æ¥å…¨å± */
        @media (max-width: 768px) {
            body {
                padding: 0;
                background: #000;
            }

            .phone-container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                padding: 0;
                box-shadow: none;
            }

            .phone-notch {
                display: none;
            }

            .app {
                border-radius: 0;
            }
        }

        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
        }

        .delete-img-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .delete-img-btn:hover {
            opacity: 1;
            background: #ff3b30;
        }

        .folder-delete-btn {
            padding: 8px;
            color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: color 0.2s;
        }

        .folder-delete-btn:hover {
            color: #ff3b30;
        }
    </style>
</head>

<body>
    <!-- æ‰‹æœºå¤–æ¡† -->
    <div class="phone-container">
        <!-- åˆ˜æµ· -->
        <div class="phone-notch"></div>

        <!-- Appä¸»ä½“ -->
        <div class="app">

            <!-- è®¾ç½®é¢æ¿ -->
            <div class="settings-panel" id="settingsPanel">
                <!-- ä¸»è®¾ç½®é¡µé¢ -->
                <div id="settingsMain">
                    <div class="settings-header">
                        <h2 class="settings-title">è®¾ç½®</h2>
                        <button class="close-btn" onclick="toggleSettings()">âœ•</button>
                    </div>

                    <!-- ä¸ªäººç»éªŒåº“å…¥å£ -->
                    <div class="settings-item">
                        <div class="settings-toggle" onclick="showSubSettings('settingsStyleLibrary')"
                            style="cursor: pointer;">
                            <span class="toggle-text">ä¸ªäººç»éªŒåº“</span>
                            <span style="color: rgba(255,255,255,0.4); font-size: 18px;">â€º</span>
                        </div>
                    </div>

                    <!-- è¾“å‡ºè®¾ç½®å…¥å£ -->
                    <div class="settings-item">
                        <div class="settings-toggle" onclick="showSubSettings('settingsFeedback')"
                            style="cursor: pointer;">
                            <span class="toggle-text">è¾“å‡ºè®¾ç½®</span>
                            <span style="color: rgba(255,255,255,0.4); font-size: 18px;">â€º</span>
                        </div>
                    </div>

                    <!-- å…³äºå…¥å£ -->
                    <div class="settings-item">
                        <div class="settings-toggle" onclick="showSubSettings('settingsAbout')"
                            style="cursor: pointer;">
                            <span class="toggle-text">å…³äº</span>
                            <span style="color: rgba(255,255,255,0.4); font-size: 18px;">â€º</span>
                        </div>
                    </div>
                </div>

                <!-- è¾“å‡ºåé¦ˆå­é¡µé¢ -->
                <div id="settingsFeedback" style="display: none;">
                    <div class="settings-header">
                        <button class="close-btn" style="width:auto; padding:0 10px; background:none; font-size:13px;"
                            onclick="hideSubSettings('settingsFeedback')">
                            â€¹ è¿”å›
                        </button>
                        <h2 class="settings-title" style="font-size: 13px;">è¾“å‡ºè®¾ç½®</h2>
                        <div style="width: 32px;"></div> <!-- å ä½ -->
                    </div>

                    <div class="settings-item">
                        <label class="settings-label">å±å¹•å æ¯”</label>
                        <div class="ratio-button-group">
                            <button class="ratio-btn" onclick="setAspectRatio('1:1', this)">1:1</button>
                            <button class="ratio-btn active" onclick="setAspectRatio('4:3', this)">4:3</button>
                            <button class="ratio-btn" onclick="setAspectRatio('16:9', this)">16:9</button>
                            <button class="ratio-btn" onclick="setAspectRatio('full', this)">å…¨å±</button>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label class="settings-label">å›¾åƒè´¨é‡</label>
                        <div class="settings-button-group">
                            <button class="settings-btn" onclick="setQuality('1080P', this)">1080P</button>
                            <button class="settings-btn active" onclick="setQuality('2K', this)">2K</button>
                            <button class="settings-btn" onclick="setQuality('4K', this)">4K</button>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label class="settings-label">ä¹å®«æ ¼å¼•å¯¼</label>
                        <div class="settings-toggle">
                            <span class="toggle-text">æ˜¾ç¤ºæ„å›¾è¾…åŠ©çº¿</span>
                            <div class="toggle-switch active" onclick="toggleGridGuide(this)"></div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label class="settings-label">è¯­éŸ³åé¦ˆ</label>
                        <div class="settings-toggle">
                            <span class="toggle-text">å¼€å¯è¯­éŸ³æç¤º</span>
                            <div class="toggle-switch active" onclick="toggleVoice(this)"></div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label class="settings-label">æ–‡æœ¬åé¦ˆ</label>
                        <div class="settings-toggle">
                            <span class="toggle-text">æ˜¾ç¤ºå±å¹•æ–‡å­—</span>
                            <div class="toggle-switch active" onclick="toggleTextFeedback(this)"></div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label class="settings-label">è™šçº¿æ¡†åé¦ˆ</label>
                        <div class="settings-toggle">
                            <span class="toggle-text">æ˜¾ç¤ºå§¿åŠ¿å¼•å¯¼</span>
                            <div class="toggle-switch active" onclick="togglePoseGuide(this)"></div>
                        </div>
                    </div>
                </div>

                <!-- ä¸ªäººé£æ ¼åº“å­é¡µé¢ -->
                <div id="settingsStyleLibrary" style="display: none;">
                    <div class="settings-header">
                        <button class="close-btn" style="width:auto; padding:0 10px; background:none; font-size:13px;"
                            onclick="hideSubSettings('settingsStyleLibrary')">
                            â€¹ è¿”å›
                        </button>
                        <h2 class="settings-title" style="font-size: 13px;">ä¸ªäººç»éªŒåº“</h2>
                        <div style="width: 32px;"></div>
                    </div>

                    <!-- é£æ ¼çŠ¶æ€ -->
                    <div class="settings-item"
                        style="background: rgba(255,214,10,0.1); border: 1px solid rgba(255,214,10,0.3);">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:20px;">ğŸ¨</span>
                            <div>
                                <div style="color:#FFD60A; font-weight:600; font-size:14px;">é£æ ¼å·²å­¦ä¹ </div>
                                <div id="styleProfileStatus"
                                    style="color:rgba(255,255,255,0.6); font-size:12px; margin-top:2px;">ç‚¹å‡»ä¸‹æ–¹æ–‡ä»¶å¤¹æŸ¥çœ‹å›¾ç‰‡
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡ä»¶å¤¹åˆ—è¡¨ -->
                    <div id="styleFolderList" style="display:flex; flex-direction:column; gap:8px; margin-top:12px;">
                        <!-- åŠ¨æ€åŠ è½½æ–‡ä»¶å¤¹ -->
                        <div style="color:rgba(255,255,255,0.5); text-align:center; padding:20px;">
                            æ­£åœ¨åŠ è½½...
                        </div>
                    </div>

                    <!-- æ–°å»ºæ–‡ä»¶å¤¹ -->
                    <div class="settings-item" style="margin-top:16px;">
                        <div onclick="createNewFolder()"
                            style="width:100%; height:44px; display:flex; align-items:center; justify-content:center; gap:8px; border:1px dashed rgba(255,255,255,0.2); border-radius:10px; cursor:pointer;">
                            <span style="font-size:18px; color:rgba(255,255,255,0.4);">ğŸ“</span>
                            <span style="color:rgba(255,255,255,0.5); font-size:13px;">æ–°å»ºæ–‡ä»¶å¤¹</span>
                        </div>
                    </div>

                    <!-- é‡æ–°å­¦ä¹ æŒ‰é’® -->
                    <button onclick="reLearnStyles()" class="settings-btn"
                        style="width:100%; margin-top:12px; background:#FFD60A; color:#000; font-weight:600; padding:14px;">
                        ğŸ¤– é‡æ–°å­¦ä¹ é£æ ¼
                    </button>
                </div>

                <!-- å…³äºå­é¡µé¢ -->
                <div id="settingsAbout" style="display: none;">
                    <div class="settings-header">
                        <button class="close-btn" style="width:auto; padding:0 10px; background:none; font-size:13px;"
                            onclick="hideSubSettings('settingsAbout')">
                            â€¹ è¿”å›
                        </button>
                        <h2 class="settings-title" style="font-size: 13px;">å…³äº</h2>
                        <div style="width: 32px;"></div>
                    </div>

                    <!-- åº”ç”¨å›¾æ ‡å’Œåç§° -->
                    <div style="text-align:center; padding:20px 0;">
                        <div style="font-size:50px; margin-bottom:10px;">âœ¨</div>
                        <div style="font-size:24px; font-weight:700; color:#fff;">Focal</div>
                        <div style="color:rgba(255,255,255,0.5); font-size:14px; margin-top:4px;">æ™ºèƒ½æ‹ç…§åŠ©æ‰‹</div>
                    </div>

                    <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
                    <div class="settings-item" style="flex-direction:column; align-items:flex-start; gap:12px;">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <span style="color:rgba(255,255,255,0.6); font-size:15px;">ç‰ˆæœ¬</span>
                            <span style="color:#fff; font-size:15px;">v6.9</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <span style="color:rgba(255,255,255,0.6); font-size:15px;">æ›´æ–°æ—¥æœŸ</span>
                            <span style="color:#fff; font-size:15px;">2026-01-18</span>
                        </div>
                    </div>

                    <!-- åŠŸèƒ½ä»‹ç» -->
                    <div class="settings-item"
                        style="flex-direction:column; align-items:flex-start; gap:8px; margin-top:8px;">
                        <div style="color:rgba(255,255,255,0.6); font-size:15px; margin-bottom:4px;">æ ¸å¿ƒåŠŸèƒ½</div>
                        <div style="color:#fff; line-height:1.8; font-size:14px;">
                            ğŸ¯ æ™ºèƒ½åœºæ™¯è¯†åˆ«ä¸æ„å›¾å»ºè®®<br>
                            ğŸ™ï¸ è¯­éŸ³äº¤äº’ä¸å®æ—¶å¼•å¯¼<br>
                            ğŸ¨ ä¸ªäººé£æ ¼åº“å­¦ä¹ <br>
                            ğŸ“ AR å§¿åŠ¿å¼•å¯¼å åŠ <br>
                            ğŸ”Š è‡ªç„¶è¯­éŸ³åé¦ˆ
                        </div>
                    </div>

                    <!-- å¼€å‘è€…ä¿¡æ¯ -->
                    <div class="settings-item"
                        style="flex-direction:column; align-items:flex-start; gap:8px; margin-top:8px;">
                        <div style="color:rgba(255,255,255,0.6); font-size:15px; margin-bottom:4px;">å¼€å‘è€…è”ç³»</div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:14px;">ğŸ“§</span>
                            <span style="color:#FFD60A; font-size:14px;">2246950894@qq.com</span>
                        </div>
                    </div>

                    <!-- ç‰ˆæƒ -->
                    <div
                        style="text-align:center; color:rgba(255,255,255,0.3); font-size:12px; margin-top:20px; padding:10px;">
                        Â© 2026 Focal. All rights reserved.
                    </div>
                </div>
            </div>

            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <!-- AIå›¾æ ‡ï¼ˆå·¦ä¸Šè§’ï¼‰ -->
                <button class="ai-icon" id="aiIcon" onclick="toggleAI()">âœ¨</button>

                <!-- è®¾ç½®æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ -->
                <button class="settings-icon" onclick="toggleSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <circle cx="12" cy="5" r="1.5" />
                        <circle cx="12" cy="12" r="1.5" />
                        <circle cx="12" cy="19" r="1.5" />
                    </svg>
                </button>
            </div>

            <!-- å–æ™¯å™¨ -->
            <div class="viewfinder">
                <video id="video" autoplay playsinline></video>

                <!-- ä¹å®«æ ¼å¼•å¯¼çº¿ -->
                <div id="gridOverlay" class="grid-overlay active">
                    <div class="grid-line horizontal" style="top: 33.33%;"></div>
                    <div class="grid-line horizontal" style="top: 66.66%;"></div>
                    <div class="grid-line vertical" style="left: 33.33%;"></div>
                    <div class="grid-line vertical" style="left: 66.66%;"></div>
                </div>

                <div id="poseOverlay" class="pose-overlay">
                    <!-- SVG å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥ -->
                </div>

                <!-- ç®­å¤´å¼•å¯¼å›¾å±‚ (NEW) -->
                <div id="arrowOverlay" class="arrow-overlay"></div>



                <div class="feedback" id="feedback">ç‚¹å‡» âœ¨ å¯åŠ¨ focal</div>

                <!-- å˜ç„¦æ§åˆ¶ -->
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="setZoom(0.5, this)">0.5</button>
                    <button class="zoom-btn" onclick="setZoom(0.75, this)">0.75</button>
                    <button class="zoom-btn active" onclick="setZoom(1.0, this)">1</button>
                    <button class="zoom-btn" onclick="setZoom(1.25, this)">1.25</button>
                    <button class="zoom-btn" onclick="setZoom(1.5, this)">1.5</button>
                </div>
            </div>

            <!-- åº•éƒ¨æ  -->
            <div class="bottom-bar">
                <button class="icon-btn">ğŸ–¼ï¸</button>
                <button class="capture-btn" onclick="capture()"></button>
                <button class="icon-btn" onclick="flipCamera()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // åº•éƒ¨æç¤ºè‡ªåŠ¨æ¶ˆå¤±
        (function () {
            function hideFeedback() {
                setTimeout(() => {
                    const feedback = document.getElementById('feedback');
                    if (feedback) {
                        console.log('éšè—åº•éƒ¨æç¤º...');
                        feedback.classList.add('fade-out');
                    }
                }, 1500);
            }

            // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideFeedback);
            } else {
                hideFeedback();
            }
        })();

        // è®¾ç½®é¢æ¿åˆ‡æ¢
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('active');

            // å¦‚æœå…³é—­é¢æ¿ï¼Œé‡ç½®å›ä¸»ç•Œé¢
            if (!panel.classList.contains('active')) {
                setTimeout(() => {
                    document.getElementById('settingsMain').style.display = 'block';
                    document.getElementById('settingsFeedback').style.display = 'none';
                }, 400); // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»ç»“æŸ
            }
        }

        // å­èœå•åˆ‡æ¢é€»è¾‘
        function showSubSettings(id) {
            document.getElementById('settingsMain').style.display = 'none';
            document.getElementById(id).style.display = 'block';
        }

        function hideSubSettings(id) {
            document.getElementById(id).style.display = 'none';
            document.getElementById('settingsMain').style.display = 'block';
        }

        // å›¾åƒè´¨é‡åˆ‡æ¢
        function setQuality(quality, btn) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.settings-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            console.log('å›¾åƒè´¨é‡å·²è®¾ç½®ä¸º:', quality);
        }

        // ==================== ä¸ªäººé£æ ¼åº“åŠŸèƒ½ ====================

        // åŠ è½½é£æ ¼æ–‡ä»¶å¤¹åˆ—è¡¨
        async function loadStyleFolders() {
            const folderList = document.getElementById('styleFolderList');
            const countSpan = document.getElementById('styleLibraryCount');

            try {
                const response = await fetch(`${API_BASE}/style_library`);
                const data = await response.json();

                if (data.folders && data.folders.length > 0) {
                    if (countSpan) countSpan.textContent = `${data.folders.length} ä¸ªåˆ†ç±»`;

                    folderList.innerHTML = data.folders.map(folder => `
                        <div class="settings-item clickable" onclick="toggleFolderImages('${folder.name}', this)" style="flex-direction:column; align-items:flex-start;" data-folder="${folder.name}" data-total="${folder.image_count}">
                            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="font-size:18px;">ğŸ“</span>
                                    <div>
                                        <div style="font-weight:600; color:#fff;">${folder.name}</div>
                                        <div style="font-size:12px; color:rgba(255,255,255,0.5);">${folder.image_count} å¼ å›¾ç‰‡</div>
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span class="folder-delete-btn" onclick="event.stopPropagation(); deleteFolder('${folder.name}')" title="åˆ é™¤æ–‡ä»¶å¤¹">ğŸ—‘ï¸</span>
                                    <span class="folder-arrow" style="color:rgba(255,255,255,0.3); font-size:14px; transition:transform 0.3s;">â–¼</span>
                                </div>
                            </div>
                            <div class="folder-images" style="display:none; width:100%; margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
                                <div class="image-grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px;">
                                    ${folder.images.slice(0, 8).map(img => `
                                        <div class="image-item">
                                            <img src="${API_BASE}/style_image/${folder.name}/${img}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2212%22>å›¾ç‰‡</text></svg>'">
                                            <div class="delete-img-btn" onclick="event.stopPropagation(); deleteImage('${folder.name}', '${img}', this)">Ã—</div>
                                        </div>
                                    `).join('')}
                                    ${folder.image_count > 8 ? `<div class="expand-more-btn" onclick="event.stopPropagation(); expandAllImages('${folder.name}', this)" style="aspect-ratio:1; border-radius:8px; background:rgba(255,214,10,0.2); display:flex; align-items:center; justify-content:center; color:#FFD60A; font-size:12px; font-weight:600; cursor:pointer;">+${folder.image_count - 8}</div>` : ''}
                                    <label onclick="event.stopPropagation()" style="aspect-ratio:1; border-radius:8px; border:1px dashed rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.4); font-size:20px; cursor:pointer;">
                                        <input type="file" multiple accept="image/*" onchange="uploadToFolder('${folder.name}', this)" style="display:none;">
                                        +
                                    </label>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // æ›´æ–°çŠ¶æ€
                    const statusDiv = document.getElementById('styleProfileStatus');
                    if (data.profile_exists) {
                        statusDiv.textContent = `å·²å­¦ä¹  ${data.folders.length} ä¸ªé£æ ¼ç±»åˆ«`;
                    } else {
                        statusDiv.textContent = 'å°šæœªå­¦ä¹ é£æ ¼ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹';
                    }
                } else {
                    if (countSpan) countSpan.textContent = 'æ— åˆ†ç±»';
                    folderList.innerHTML = `
                        <div style="color:rgba(255,255,255,0.5); text-align:center; padding:30px;">
                            <div style="font-size:40px; margin-bottom:10px;">ğŸ“‚</div>
                            <div>æš‚æ— é£æ ¼å›¾ç‰‡</div>
                            <div style="font-size:12px; margin-top:5px;">è¯·ä¸Šä¼ å›¾ç‰‡åˆ° user_styles æ–‡ä»¶å¤¹</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½é£æ ¼åº“å¤±è´¥:', error);
                folderList.innerHTML = `
                    <div style="color:rgba(255,100,100,0.8); text-align:center; padding:20px;">
                        åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨
                    </div>
                `;
            }
        }

        // åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æ”¶èµ·
        function toggleFolderImages(folderName, element) {
            const imagesDiv = element.querySelector('.folder-images');
            const arrow = element.querySelector('.folder-arrow');

            if (imagesDiv.style.display === 'none') {
                imagesDiv.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                imagesDiv.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // å±•å¼€æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
        async function expandAllImages(folderName, btn) {
            btn.textContent = 'åŠ è½½ä¸­...';
            btn.style.pointerEvents = 'none';

            try {
                // è·å–å®Œæ•´çš„å›¾ç‰‡åˆ—è¡¨
                const response = await fetch(`${API_BASE}/style_library`);
                const data = await response.json();

                const folder = data.folders.find(f => f.name === folderName);
                if (!folder) return;

                // è·å–æ‰€æœ‰å›¾ç‰‡ï¼ˆåç«¯è¿”å›çš„æ˜¯å‰12å¼ ï¼Œè¿™é‡Œè¯·æ±‚å®Œæ•´åˆ—è¡¨ï¼‰
                const allImagesResponse = await fetch(`${API_BASE}/style_folder/${folderName}`);
                let allImages;

                if (allImagesResponse.ok) {
                    const folderData = await allImagesResponse.json();
                    allImages = folderData.images;
                } else {
                    // å¦‚æœæ²¡æœ‰å®Œæ•´åˆ—è¡¨ï¼Œä½¿ç”¨å·²æœ‰çš„å‰12å¼ 
                    allImages = folder.images;
                }

                // æ‰¾åˆ°å›¾ç‰‡ç½‘æ ¼å®¹å™¨
                const grid = btn.parentElement;

                // ç”Ÿæˆæ‰€æœ‰å›¾ç‰‡ + ä¿ç•™æ·»åŠ æŒ‰é’® + ä¿ç•™åˆ é™¤æŒ‰é’®
                grid.innerHTML = allImages.map(img => `
                    <div class="image-item">
                        <img src="${API_BASE}/style_image/${folderName}/${img}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2212%22>å›¾ç‰‡</text></svg>'">
                        <div class="delete-img-btn" onclick="event.stopPropagation(); deleteImage('${folderName}', '${img}', this)">Ã—</div>
                    </div>
                `).join('') + `
                    <label onclick="event.stopPropagation()" style="aspect-ratio:1; border-radius:8px; border:1px dashed rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.4); font-size:20px; cursor:pointer;">
                        <input type="file" multiple accept="image/*" onchange="uploadToFolder('${folderName}', this)" style="display:none;">
                        +
                    </label>
                `;

            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                btn.textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // é‡æ–°å­¦ä¹ é£æ ¼
        async function reLearnStyles() {
            const statusDiv = document.getElementById('styleProfileStatus');
            const btn = document.querySelector('button[onclick="reLearnStyles()"]');

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'â³ æ­£åœ¨å­¦ä¹ ä¸­...';
            }
            statusDiv.textContent = 'æ­£åœ¨åˆ†æå›¾ç‰‡é£æ ¼ï¼Œè¯·ç¨å€™...';

            try {
                const response = await fetch(`${API_BASE}/relearn_styles`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    statusDiv.textContent = `âœ… ${result.message}`;
                    showFeedback('âœ… é£æ ¼å­¦ä¹ å®Œæˆï¼', 2000);
                    // åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨
                    loadStyleFolders();
                } else {
                    statusDiv.textContent = 'âŒ ' + result.error;
                    showFeedback('å­¦ä¹ å¤±è´¥: ' + result.error, 3000);
                }
            } catch (error) {
                console.error('é‡æ–°å­¦ä¹ å¤±è´¥:', error);
                statusDiv.textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨';
                showFeedback('âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡', 3000);
            } finally {
                // æ¢å¤æŒ‰é’®
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ¤– é‡æ–°å­¦ä¹ é£æ ¼';
                }
            }
        }

        // é£æ ¼ç…§ç‰‡ä¸Šä¼ 
        async function handleStyleUpload(input) {
            const files = input.files;
            if (!files.length) return;

            showFeedback('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 2000);

            const imagePromises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve(e.target.result.split(',')[1]);
                    };
                    reader.readAsDataURL(file);
                });
            });

            try {
                const base64Images = await Promise.all(imagePromises);

                const response = await fetch(`${API_BASE}/learn_style`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: base64Images })
                });

                const result = await response.json();
                if (result.success) {
                    showFeedback('âœ… é£æ ¼å·²å­¦ä¹ ', 2000);
                    loadStyleFolders(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showFeedback('å­¦ä¹ å¤±è´¥ï¼Œè¯·é‡è¯•', 2000);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showFeedback('ä¸Šä¼ å‡ºé”™', 2000);
            }
        }

        // æ–°å»ºæ–‡ä»¶å¤¹
        async function createNewFolder() {
            const folderName = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼š', '');
            if (!folderName || folderName.trim() === '') {
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤¹åç§°ï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­æ–‡ï¼‰
            const cleanName = folderName.trim().replace(/[^\w\u4e00-\u9fa5-]/g, '_');

            try {
                const response = await fetch(`${API_BASE}/create_folder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_name: cleanName })
                });

                const result = await response.json();
                if (result.success) {
                    showFeedback(`âœ… æ–‡ä»¶å¤¹ "${cleanName}" å·²åˆ›å»º`, 2000);
                    loadStyleFolders(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showFeedback('åˆ›å»ºå¤±è´¥: ' + result.error, 2000);
                }
            } catch (error) {
                console.error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥:', error);
                showFeedback('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨', 2000);
            }
        }

        // ä¸Šä¼ å›¾ç‰‡åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
        async function uploadToFolder(folderName, input) {
            const files = input.files;
            if (!files.length) return;

            showFeedback(`æ­£åœ¨ä¸Šä¼ åˆ° ${folderName}...`, 2000);

            try {
                const formData = new FormData();
                formData.append('folder_name', folderName);
                for (let file of files) {
                    formData.append('files', file);
                }

                const response = await fetch(`${API_BASE}/upload_to_folder`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showFeedback(`âœ… å·²ä¸Šä¼  ${result.count} å¼ å›¾ç‰‡`, 2000);
                    loadStyleFolders(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showFeedback('ä¸Šä¼ å¤±è´¥: ' + result.error, 2000);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showFeedback('ä¸Šä¼ å‡ºé”™', 2000);
            }

            // æ¸…ç©º input ä»¥ä¾¿å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
            input.value = '';
        }

        // åˆ é™¤æ–‡ä»¶å¤¹
        async function deleteFolder(folderName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${folderName}" åŠå…¶ä¸­çš„æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/delete_folder/${folderName}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showFeedback(`âœ… æ–‡ä»¶å¤¹ "${folderName}" å·²åˆ é™¤`, 2000);
                    loadStyleFolders(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showFeedback('åˆ é™¤å¤±è´¥: ' + result.error, 2000);
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥:', error);
                showFeedback('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 2000);
            }
        }

        // åˆ é™¤å•å¼ å›¾ç‰‡
        async function deleteImage(folderName, filename, btn) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/delete_image/${folderName}/${filename}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showFeedback('âœ… å›¾ç‰‡å·²åˆ é™¤', 1500);
                    // å±€éƒ¨æ›´æ–° UI
                    const container = btn.closest('.image-item');
                    if (container) {
                        container.remove();
                    }
                    // æ›´æ–°æ–‡ä»¶å¤¹ç»Ÿè®¡æ–‡æœ¬ï¼ˆå¯é€‰ï¼Œæˆ–è€…å…¨é‡åˆ·æ–°ï¼‰
                    // loadStyleFolders(); 
                } else {
                    showFeedback('åˆ é™¤å¤±è´¥: ' + result.error, 2000);
                }
            } catch (error) {
                console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                showFeedback('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 2000);
            }
        }

        // æ‰“å¼€é£æ ¼åº“æ—¶åŠ è½½æ–‡ä»¶å¤¹
        const originalShowSubSettings = showSubSettings;
        showSubSettings = function (panelId) {
            originalShowSubSettings(panelId);
            if (panelId === 'settingsStyleLibrary') {
                loadStyleFolders();
            }
        };

        // å˜ç„¦æ§åˆ¶ï¼ˆæŒ‰é’®ï¼‰
        let currentZoom = 1.0;

        function setZoom(factor, btn) {
            currentZoom = factor;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // åº”ç”¨CSSç¼©æ”¾
            const video = document.getElementById('video');
            if (video) {
                video.style.transform = `scale(${currentZoom}) scaleX(-1)`;
                video.style.transformOrigin = 'center center';
            }
        }

        // ç¿»è½¬æ‘„åƒå¤´
        let facingMode = 'user';
        async function flipCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode, width: 720, height: 1280 }
                });
                document.getElementById('video').srcObject = stream;
            } catch (e) {
                updateFeedback('âš ï¸ è¯·å…è®¸æ‘„åƒå¤´æƒé™');
            }
        }

        // ==================== Focal AI Agent æ ¸å¿ƒæ¨¡å— ====================
        // æµç¨‹: å”¤é†’æ„ŸçŸ¥ â†’ å¯¼æ¼”å†³ç­– â†’ ARåˆå§‹åŒ– â†’ å®æ—¶å¼•å¯¼ â†’ å®Œç¾æ‹æ‘„

        const API_BASE = 'http://localhost:8000';  // åç«¯ API åœ°å€

        // ==================== AR å§¿åŠ¿å¼•å¯¼èµ„æº ====================
        const POSE_PATHS = {
            // --- è‡ªæ‹æ¨¡å¼ (Selfie) ---
            "selfie_standard": "M150,110 Q195,110 195,160 Q195,210 150,210 Q105,210 105,160 Q105,110 150,110 M100,240 Q100,220 120,215 M200,240 Q200,220 180,215", // åªæ˜¾ç¤ºå¤´å’Œè‚©è†€è½®å»“
            "selfie_hand_chin": "M150,110 Q195,110 195,160 Q195,210 150,210 Q105,210 105,160 Q105,110 150,110 M100,240 Q100,220 120,215 M200,240 Q200,220 180,215 M130,220 Q140,200 120,195", // å¢åŠ äº†ä¸€ä¸ªç®€å•çš„æ‰˜è…®æ‰‹åŠ¿å¼•å¯¼

            // --- åŠèº«æ¨¡å¼ (Upper Body) ---
            "upper_casual": "M150,80 Q180,80 180,115 Q180,150 150,150 Q120,150 120,115 Q120,80 150,80 M150,150 L150,260 M150,170 L110,230 M150,170 L190,230 M110,230 L105,280 M190,230 L195,280",
            "upper_cool": "M150,80 Q180,80 180,115 Q180,150 150,150 Q120,150 120,115 Q120,80 150,80 M150,150 L150,260 M150,170 L120,220 L100,210 M150,170 L180,230 L185,270",

            // --- å…¨èº«æ¨¡å¼ (Full Body) ---
            "full_standard": "M150,60 Q180,60 180,90 Q180,120 150,120 Q120,120 120,90 Q120,60 150,60 M150,120 L150,260 M150,150 L100,220 M150,150 L200,220 M150,260 L130,400 M150,260 L170,400",

            "default": "M150,110 Q195,110 195,160 Q195,210 150,210 Q105,210 105,160 Q105,110 150,110" // é»˜è®¤é€€å›åˆ°è‡ªæ‹æ¡†
        };

        const ARROW_PATHS = {
            "move_left": "M200,100 L120,150 L200,200 Z",
            "move_right": "M100,100 L180,150 L100,200 Z",
            "move_up": "M100,200 L150,120 L200,200 Z",
            "move_down": "M100,100 L150,180 L200,100 Z",
            "tilt_up": "M100,200 Q150,80 200,200 M150,80 L135,100 M150,80 L165,100",
            "tilt_down": "M100,100 Q150,220 200,100 M150,220 L135,200 M150,220 L165,200",
            "zoom_in": "M100,100 L140,140 M200,100 L160,140 M100,200 L140,160 M200,200 L160,160",
            "zoom_out": "M140,140 L100,100 M160,140 L200,100 M140,160 L100,200 M160,160 L200,200"
        };


        // ==================== A. å”¤é†’ä¸æ„ŸçŸ¥ (Wake & Sense) ====================

        const FocalAgent = {
            isActive: false,           // Agent æ˜¯å¦æ¿€æ´»
            isAnalyzing: false,        // æ˜¯å¦æ­£åœ¨åˆ†æ
            analysisInterval: null,    // åˆ†æå®šæ—¶å™¨
            currentScene: null,        // å½“å‰åœºæ™¯
            currentPose: null,         // å½“å‰æ¨èå§¿åŠ¿
            voiceEnabled: true,        // è¯­éŸ³å¼•å¯¼å¼€å…³
            textFeedbackEnabled: true, // æ–‡æœ¬åé¦ˆå¼€å…³
            poseGuideEnabled: true,    // å§¿åŠ¿å¼•å¯¼å¼€å…³
            analysisFrequency: 3000,   // åˆ†æé¢‘ç‡ (ms)
            canvas: null,              // æˆªå›¾ç”»å¸ƒ
            ctx: null,                 // ç”»å¸ƒä¸Šä¸‹æ–‡
            recognition: null,         // è¯­éŸ³è¯†åˆ«å¯¹è±¡
            userSpeechBuffer: '',     // è¯­éŸ³ç¼“å†²åŒº
            isRecording: false,        // æ˜¯å¦æ­£åœ¨å½•éŸ³
            silenceTimer: null,        // é™éŸ³æäº¤å®šæ—¶å™¨

            // åˆå§‹åŒ– Agent
            init() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.initSpeechRecognition();
                console.log('ğŸš€ Focal Agent åˆå§‹åŒ–å®Œæˆ');
            },

            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API');
                    return;
                }

                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'zh-CN';

                this.recognition.onstart = () => {
                    this.isRecording = true;
                    const aiIcon = document.getElementById('aiIcon');
                    if (aiIcon) aiIcon.classList.add('is-listening');
                    console.log('ğŸ™ï¸ è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
                };

                this.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            this.userSpeechBuffer += event.results[i][0].transcript;

                            // [Fix] ä»…åœ¨æœ‰å†…å®¹æ—¶æ‰“å°ï¼Œé¿å…ç©ºç™½æ—¥å¿—é€ æˆçš„å›°æƒ‘
                            if (this.userSpeechBuffer.trim()) {
                                console.log('ğŸ—£ï¸ æœ€ç»ˆç»“æœ:', this.userSpeechBuffer);
                                showFeedback(`â€œ${this.userSpeechBuffer}â€`, 1000);
                                this.handleSpeechInput();
                            }
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    // å½“ç”¨æˆ·è¯´è¯æ—¶ï¼Œæ˜¾ç¤ºå®æ—¶é¢„è§ˆ
                    if (interimTranscript.length > 0) {
                        const feedback = document.getElementById('feedback');
                        if (feedback) {
                            feedback.textContent = `å¬åˆ°äº†: ${interimTranscript}...`;
                            feedback.classList.remove('fade-out');
                        }

                        // æ‰“æ–­é€»è¾‘ï¼šåœæ­¢ AI è¯´è¯
                        if (speechSynthesis.speaking) {
                            speechSynthesis.cancel();
                        }
                    }
                };

                this.recognition.onerror = (event) => {
                    console.error('ğŸ¤ è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                    if (event.error === 'no-speech') return;
                    this.isRecording = false;
                };

                this.recognition.onend = () => {
                    this.isRecording = false;
                    const aiIcon = document.getElementById('aiIcon');
                    if (aiIcon) aiIcon.classList.remove('is-listening');

                    // å¦‚æœ Agent ä»ç„¶æ¿€æ´»ï¼Œåˆ™é‡å¯è¯†åˆ«ï¼ˆå®ç°æŒç»­ç›‘å¬ï¼‰
                    if (this.isActive) {
                        setTimeout(() => this.startVoiceRecognition(), 500);
                    }
                };
            },

            // ==================== AR å§¿åŠ¿å¼•å¯¼ ====================

            updatePoseGuide(poseId) {
                const overlay = document.getElementById('poseOverlay');
                if (!overlay) return;

                // æ£€æŸ¥å§¿åŠ¿å¼•å¯¼æ˜¯å¦å¼€å¯
                if (!this.poseGuideEnabled || poseId === "none") {
                    overlay.classList.remove('active');
                    overlay.innerHTML = '';
                    return;
                }

                // æŸ¥æ‰¾è·¯å¾„ï¼Œæ²¡æœ‰åˆ™ç”¨ default
                const pathData = POSE_PATHS[poseId] || POSE_PATHS["default"];

                // ç”Ÿæˆ SVG
                const svgContent = `
                    <svg viewBox="0 0 300 600" preserveAspectRatio="xMidYMid meet" style="width:100%; height:100%;">
                        <path d="${pathData}" class="pose-path" vector-effect="non-scaling-stroke"/>
                    </svg>
                `;

                overlay.innerHTML = svgContent;
                overlay.classList.add('active');
            },



            // å¤„ç†è¯­éŸ³è¾“å…¥ï¼šæ£€æµ‹åˆ°æœ‰æ•ˆè¾“å…¥åè§¦å‘åˆ†æ
            handleSpeechInput() {
                if (this.userSpeechBuffer.trim().length > 0) {
                    clearTimeout(this.silenceTimer);
                    this.silenceTimer = setTimeout(() => {
                        console.log('ğŸš¦ è§¦å‘ç»¼åˆåˆ†æè¯·æ±‚...');
                        this.senseAndDecide(this.userSpeechBuffer);
                        this.userSpeechBuffer = ''; // å‘é€åæ¸…ç©º
                    }, 800);
                }
            },

            // å¼€å¯è¯­éŸ³ç›‘å¬
            startVoiceRecognition() {
                if (this.recognition && !this.isRecording) {
                    try {
                        this.recognition.start();
                    } catch (e) {
                        console.warn('è¯­éŸ³å¯åŠ¨è­¦å‘Š:', e);
                    }
                }
            },

            // åœæ­¢è¯­éŸ³ç›‘å¬
            stopVoiceRecognition() {
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                }
            },

            // å”¤é†’ Agentï¼ˆç‚¹å‡»âœ¨å›¾æ ‡æ—¶è§¦å‘ï¼‰
            async wake() {
                if (this.isActive) {
                    this.sleep();
                    return;
                }

                this.isActive = true;
                console.log('âœ¨ Focal Agent å·²å”¤é†’');
                showFeedback('focal æ­£åœ¨åˆ†æåœºæ™¯...');

                // ç«‹å³è¿›è¡Œç¬¬ä¸€æ¬¡åˆ†æ
                await this.senseAndDecide();

                // å¯åŠ¨æŒç»­æ„ŸçŸ¥å¾ªç¯
                this.startGuidanceLoop();

                // å¯åŠ¨è¯­éŸ³ç›‘å¬
                this.startVoiceRecognition();
            },

            // ä¼‘çœ  Agent - å®Œå…¨åœæ­¢ AI åˆ†æå’Œè¯­éŸ³
            sleep() {
                this.isActive = false;
                this.isAnalyzing = false;

                // 1. åœæ­¢å¾ªç¯é€»è¾‘
                this.stopGuidanceLoop();

                // 2. åœæ­¢è¯­éŸ³è¯†åˆ« (æ ¸å¿ƒï¼šåˆ‡æ–­è€³æœµ)
                this.stopVoiceRecognition();

                // 3. åœæ­¢è¯­éŸ³è¾“å‡º (æ ¸å¿ƒï¼šåˆ‡æ–­å˜´å·´)
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }

                // 4. æ¸…ç† UI è¦†ç›–å±‚
                const aiIcon = document.getElementById('aiIcon');
                if (aiIcon) aiIcon.classList.remove('is-listening');

                // éšè— AR å¼•å¯¼çº¿
                this.updatePoseGuide("none"); // ä¼ å…¥æ— æ•ˆ ID å¯æ¸…é™¤ï¼Œæˆ–è€…è°ƒç”¨ hidePoseGuide å¦‚æœæœ‰çš„è¯
                // ç”±äº updatePoseGuide åªæ˜¯åŠ å†…å®¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¸…ç†é€»è¾‘ã€‚
                // æ—¢ç„¶å®šä¹‰äº† hidePoseGuide (ä¹‹å‰æ²¡åŠ è¿› FocalAgent, åªæ˜¯å…¨å±€å‡½æ•°? ä¸, æˆ‘ä¸Šä¸€æ­¥åŠ çš„æ˜¯ updatePoseGuide)
                // è®©æˆ‘ç›´æ¥æ“ä½œ DOM ç§»é™¤ active class å§ï¼Œæˆ–è€…ä¼ å…¥ null
                const overlay = document.getElementById('poseOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    overlay.innerHTML = '';
                }

                console.log('ğŸ˜´ Focal Agent å·²ä¼‘çœ  - éº¦å…‹é£å·²é‡Šæ”¾');
                showFeedback('focal å·²å…³é—­', 1000);
            },

            // æ„ŸçŸ¥å½“å‰ç”»é¢
            async captureFrame() {
                const video = document.getElementById('video');
                if (!video || !video.videoWidth) return null;

                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                const scale = 0.35;  // [ä¼˜åŒ–] è¿›ä¸€æ­¥é™ä½åˆ†è¾¨ç‡ä»¥åŠ å¿«ä¸Šä¼ é€Ÿåº¦ (Race Mode Ready)
                this.canvas.width = video.videoWidth * scale;
                this.canvas.height = video.videoHeight * scale;

                // ç»˜åˆ¶å½“å‰å¸§
                this.ctx.drawImage(video, 0, 0, this.canvas.width, this.canvas.height);

                // è½¬æ¢ä¸º base64 (ä½¿ç”¨ webp æ ¼å¼ï¼Œä½“ç§¯æ›´å°)
                // [ä¼˜åŒ–] è´¨é‡é™è‡³ 0.6ï¼Œè§†è§‰è¯†åˆ«ä¸å—å½±å“ä½†ä½“ç§¯å‡åŠ
                const imageData = this.canvas.toDataURL('image/webp', 0.6);
                return imageData.split(',')[1];  // è¿”å›çº¯ base64
            },

            // ==================== B. å¯¼æ¼”å†³ç­– (The Director) ====================

            async senseAndDecide(userMessage = null) {
                if (this.isAnalyzing) return null;

                this.isAnalyzing = true;

                try {
                    // æ„ŸçŸ¥ï¼šæ•è·å½“å‰ç”»é¢
                    const imageBase64 = await this.captureFrame();
                    if (!imageBase64) {
                        console.warn('âš ï¸ æ— æ³•æ•è·ç”»é¢');
                        return null;
                    }

                    console.log('ğŸ“· å·²æ•è·ç”»é¢ï¼Œå‘é€è‡³ Director...');

                    // å†³ç­–ï¼šè°ƒç”¨ AI Director API
                    const response = await fetch(`${API_BASE}/analyze_image`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_base64: imageBase64,
                            image_format: 'webp',
                            user_message: userMessage || this.userSpeechBuffer
                        })
                    });

                    // æ¸…ç©ºå·²å‘é€çš„ç¼“å†²åŒºï¼ˆå¦‚æœæ˜¯é€šè¿‡è½®è¯¢å‘é€çš„ï¼‰
                    if (!userMessage) this.userSpeechBuffer = '';

                    if (!response.ok) {
                        throw new Error(`API é”™è¯¯: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        console.log('ğŸ¬ Director å†³ç­–:', result.data);
                        return this.processDirectorDecision(result.data);
                    }

                } catch (error) {
                    console.error('âŒ Director è°ƒç”¨å¤±è´¥:', error);
                    showFeedback('âš ï¸ AI è¿æ¥å¤±è´¥', 2000);
                } finally {
                    this.isAnalyzing = false;
                }

                return null;
            },

            // å¤„ç† Director çš„å†³ç­–
            processDirectorDecision(decision) {
                const { detected_scene, scene_analysis, direction_guidance, recommended_pose_id, voice_feedback, action } = decision;

                // æ›´æ–°å½“å‰çŠ¶æ€
                // æ›´æ–°å½“å‰çŠ¶æ€
                this.currentScene = detected_scene;
                this.currentPose = recommended_pose_id;

                // C. AR åˆå§‹åŒ– - æ˜¾ç¤ºå¼•å¯¼ä¿¡æ¯
                // this.setupARGuidance(decision);

                // æ˜¾ç¤ºå§¿åŠ¿å¼•å¯¼çº¿ (NEW)
                if (recommended_pose_id) {
                    this.updatePoseGuide(recommended_pose_id);
                }

                // æ˜¾ç¤ºç®­å¤´å¼•å¯¼ (NEW)
                this.updateArrowGuide(direction_guidance);

                // D. æ ¹æ® action æ‰§è¡Œå¯¹åº”æ“ä½œ
                switch (action) {
                    case 'capture':
                        // ç«‹å³æ‹ç…§
                        if (!this.voiceEnabled) showFeedback('ğŸ“¸ å‡†å¤‡æ‹æ‘„...', 1000);
                        setTimeout(() => this.capturePhoto(), 1000);
                        break;

                    case 'change_pose':
                    case 'talk':
                    case 'continue':
                    default:
                        // å¦‚æœæ²¡æœ‰è¯­éŸ³ï¼Œæ‰‹åŠ¨æ˜¾ç¤ºåé¦ˆ
                        if (!this.voiceEnabled && voice_feedback) {
                            showFeedback(voice_feedback, 2000);
                        }
                        break;
                }

                // è¯­éŸ³åé¦ˆï¼ˆåŒæ—¶æ˜¾ç¤ºå­—å¹•ï¼‰
                if (this.voiceEnabled && voice_feedback) {
                    this.speak(voice_feedback);
                }

                return decision;
            },

            // ==================== C. AR åˆå§‹åŒ– (AR Setup) ====================

            setupARGuidance(decision) {
                // æ›´æ–°åœºæ™¯ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦æ˜¾ç¤ºåœ¨ UI ä¸Šï¼‰
                if (decision.scene_analysis) {
                    console.log('ğŸŒ„ åœºæ™¯åˆ†æ:', decision.scene_analysis);
                }

                // æ›´æ–°æ¨èå§¿åŠ¿ï¼ˆå¦‚æœéœ€è¦æ˜¾ç¤ºåœ¨ UI ä¸Šï¼‰
                if (decision.recommended_pose_id) {
                    console.log('ğŸ’ƒ æ¨èå§¿åŠ¿:', decision.recommended_pose_id);
                }
            },

            // ==================== D. å®æ—¶å¼•å¯¼é—­ç¯ (The Guidance Loop) ====================

            startGuidanceLoop() {
                if (this.analysisInterval) return;  // é¿å…é‡å¤å¯åŠ¨

                console.log('ğŸ”„ å¯åŠ¨å®æ—¶å¼•å¯¼å¾ªç¯');

                this.analysisInterval = setInterval(async () => {
                    if (this.isActive && !this.isAnalyzing) {
                        await this.senseAndDecide();
                    }
                }, this.analysisFrequency);
            },

            stopGuidanceLoop() {
                if (this.analysisInterval) {
                    clearInterval(this.analysisInterval);
                    this.analysisInterval = null;
                    console.log('â¹ï¸ åœæ­¢å®æ—¶å¼•å¯¼å¾ªç¯');
                }
            },

            // ==================== E. å®Œç¾æ‹æ‘„ (Capture) ====================

            async capturePhoto() {
                const video = document.getElementById('video');
                if (!video) return;

                // åˆ›å»ºå…¨åˆ†è¾¨ç‡æˆªå›¾
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const ctx = captureCanvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                // è·å–å›¾ç‰‡æ•°æ®
                const imageData = captureCanvas.toDataURL('image/jpeg', 0.95);

                // æ˜¾ç¤ºæ‹æ‘„æˆåŠŸ
                showFeedback('ğŸ“¸ æ‹æ‘„æˆåŠŸï¼', 2000);

                // è¯­éŸ³åé¦ˆ
                if (this.voiceEnabled) {
                    this.speak('å¾ˆå¥½ï¼Œè¿™å¼ å¾ˆæ£’ï¼');
                }

                // ä¸‹è½½å›¾ç‰‡
                const link = document.createElement('a');
                link.download = `focal_${Date.now()}.jpg`;
                link.href = imageData;
                link.click();

                console.log('ğŸ“· ç…§ç‰‡å·²ä¿å­˜');
            },

            // è¯­éŸ³åé¦ˆï¼ˆä½¿ç”¨ Web Speech APIï¼Œå…ƒæ°”æ´»æ³¼çš„å£°éŸ³ï¼‰
            // åŒæ—¶æ˜¾ç¤ºå­—å¹•ï¼Œè¯­éŸ³å’Œæ–‡å­—å®Œå…¨åŒæ­¥
            speak(text) {
                // ä¸»å¼€å…³æ£€æŸ¥ï¼šAI å…³é—­æ—¶ä¸æ’­æ”¾ä»»ä½•å£°éŸ³
                if (!this.isActive) return;
                if (!this.voiceEnabled) return;

                // æ˜¾ç¤ºå­—å¹•ï¼ˆä¸è¯­éŸ³åŒæ­¥ï¼‰
                showFeedback(text, 0);  // æŒç»­æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨æ¶ˆå¤±

                if ('speechSynthesis' in window) {
                    // å–æ¶ˆä¹‹å‰çš„è¯­éŸ³ï¼Œé¿å…é‡å 
                    speechSynthesis.cancel();

                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 1.4;    // æ›´å¿«çš„è¯­é€Ÿ
                    utterance.pitch = 1.3;   // è¾ƒé«˜çš„éŸ³è°ƒï¼Œæ›´å…ƒæ°”
                    utterance.volume = 0.9;

                    // é€‰æ‹©å¥³å£°ï¼ˆæ›´æ´»æ³¼ï¼‰
                    const voices = speechSynthesis.getVoices();
                    const femaleVoice = voices.find(v =>
                        v.lang.includes('zh') && (v.name.includes('Female') || v.name.includes('å¥³') || v.name.includes('Ting'))
                    );
                    if (femaleVoice) utterance.voice = femaleVoice;

                    // è¯­éŸ³ç»“æŸåéšè—å­—å¹•
                    utterance.onend = () => {
                        setTimeout(() => {
                            const feedback = document.getElementById('feedback');
                            if (feedback) feedback.classList.add('fade-out');
                        }, 300);
                    };

                    speechSynthesis.speak(utterance);
                } else {
                    // æ²¡æœ‰è¯­éŸ³APIæ—¶ï¼Œ0.8ç§’åæ¶ˆå¤±
                    setTimeout(() => {
                        const feedback = document.getElementById('feedback');
                        if (feedback) feedback.classList.add('fade-out');
                    }, 800);
                }
            }
        };

        // ==================== UI äº¤äº’å¢å¼º ====================

        // æ˜¾ç¤ºåé¦ˆä¿¡æ¯ï¼ˆæ”¯æŒé•¿æ–‡æœ¬åˆ†æ®µæ˜¾ç¤ºï¼‰
        let feedbackQueue = [];
        let isShowingFeedback = false;

        function showFeedback(text, duration = 800) {
            const feedback = document.getElementById('feedback');
            if (!feedback) return;

            // æ£€æŸ¥æ–‡æœ¬åé¦ˆæ˜¯å¦å¼€å¯
            if (!FocalAgent.textFeedbackEnabled) {
                feedback.classList.add('fade-out');
                return;
            }

            // æŒ‰æ ‡ç‚¹ç¬¦å·åˆ†å‰²é•¿æ–‡æœ¬
            const maxLength = 20;  // æ¯æ®µæœ€å¤§å­—ç¬¦æ•°
            if (text.length > maxLength) {
                // æŒ‰é€—å·ã€å¥å·ç­‰åˆ†å‰²
                const segments = text.split(/([ï¼Œ,ã€‚ï¼ï¼Ÿã€])/);
                let currentSegment = '';
                const parts = [];

                for (let i = 0; i < segments.length; i++) {
                    currentSegment += segments[i];
                    if (currentSegment.length >= maxLength || i === segments.length - 1) {
                        if (currentSegment.trim()) {
                            parts.push(currentSegment.trim());
                        }
                        currentSegment = '';
                    }
                }

                // åŠ å…¥é˜Ÿåˆ—ä¾æ¬¡æ˜¾ç¤º
                if (parts.length > 1) {
                    parts.forEach((part, index) => {
                        feedbackQueue.push({ text: part, duration: duration || 1200 });
                    });
                    processQueue();
                    return;
                }
            }

            // ç›´æ¥æ˜¾ç¤º
            feedback.textContent = text;
            feedback.classList.remove('fade-out');

            if (duration > 0) {
                setTimeout(() => {
                    feedback.classList.add('fade-out');
                }, duration);
            }
        }

        function processQueue() {
            if (isShowingFeedback || feedbackQueue.length === 0) return;

            isShowingFeedback = true;
            const item = feedbackQueue.shift();
            const feedback = document.getElementById('feedback');

            feedback.textContent = item.text;
            feedback.classList.remove('fade-out');

            setTimeout(() => {
                feedback.classList.add('fade-out');
                setTimeout(() => {
                    isShowingFeedback = false;
                    processQueue();
                }, 500);
            }, item.duration);
        }

        // é‡å†™ toggleAI ä»¥é›†æˆ Agent
        function toggleAI() {
            const icon = document.getElementById('aiIcon');
            icon.classList.toggle('active');

            if (icon.classList.contains('active')) {
                FocalAgent.wake();
            } else {
                FocalAgent.sleep();
            }
        }

        // é‡å†™ capture ä»¥ä½¿ç”¨ Agent
        function capture() {
            if (FocalAgent.isActive) {
                FocalAgent.capturePhoto();
            } else {
                showFeedback('ğŸ“¸ æ‹æ‘„æˆåŠŸï¼', 2000);
            }
        }

        // ä¹å®«æ ¼å¼•å¯¼å¼€å…³
        function toggleGridGuide(element) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            const overlay = document.getElementById('gridOverlay');

            if (isActive) {
                overlay.classList.add('active');
                showFeedback('ä¹å®«æ ¼å·²å¼€å¯', 1000);
            } else {
                overlay.classList.remove('active');
            }
        }

        // è®¾ç½®å±å¹•æ¯”ä¾‹
        function setAspectRatio(ratio, btn) {
            const viewfinder = document.querySelector('.viewfinder');
            viewfinder.setAttribute('data-ratio', ratio);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            showFeedback(`å±å¹•æ¯”ä¾‹: ${ratio === 'full' ? 'å…¨å±' : ratio}`, 1000);
        }

        // è¯­éŸ³å¼€å…³
        function toggleVoice(element) {
            element.classList.toggle('active');
            FocalAgent.voiceEnabled = element.classList.contains('active');
            showFeedback(FocalAgent.voiceEnabled ? 'è¯­éŸ³å¼•å¯¼å·²å¼€å¯' : 'è¯­éŸ³å¼•å¯¼å·²å…³é—­', 1000);
        }

        // æ–‡æœ¬åé¦ˆå¼€å…³
        function toggleTextFeedback(element) {
            element.classList.toggle('active');
            FocalAgent.textFeedbackEnabled = element.classList.contains('active');

            const feedback = document.getElementById('feedback');
            if (!FocalAgent.textFeedbackEnabled) {
                feedback.classList.add('fade-out');
            } else {
                showFeedback('æ–‡æœ¬åé¦ˆå·²å¼€å¯', 1000);
            }
        }

        // å§¿åŠ¿å¼•å¯¼å¼€å…³
        function togglePoseGuide(element) {
            element.classList.toggle('active');
            FocalAgent.poseGuideEnabled = element.classList.contains('active');

            const overlay = document.getElementById('poseOverlay');
            if (!FocalAgent.poseGuideEnabled) {
                overlay.classList.remove('active');
                overlay.innerHTML = '';
            } else {
                showFeedback('å§¿åŠ¿å¼•å¯¼å·²å¼€å¯', 1000);
            }
        }

        // åˆå§‹åŒ–
        FocalAgent.init();
        startCamera();
    </script>
</body>

</html>