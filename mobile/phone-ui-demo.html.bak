<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focal - æ‰‹æœºUIæ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* æ‰‹æœºå¤–æ¡† */
        .phone-container {
            width: 390px;
            height: 844px;
            background: #1a1a1a;
            border-radius: 50px;
            padding: 12px;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
        }

        /* åˆ˜æµ· */
        .phone-notch {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 30px;
            background: #1a1a1a;
            border-radius: 0 0 20px 20px;
            z-index: 1000;
        }

        /* Appå†…å®¹åŒº */
        .app {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(20, 20, 20, 0.98);
            backdrop-filter: blur(30px);
            padding: 60px 20px 30px;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            max-height: 80%;
            overflow-y: auto;
        }

        .settings-panel.active {
            transform: translateY(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .settings-item {
            margin-bottom: 24px;
        }

        .settings-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 8px;
            display: block;
        }

        .settings-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .toggle-text {
            color: #fff;
            font-size: 15px;
        }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #34c759;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* è®¾ç½®é¡¹æŒ‰é’®ç»„ */
        .settings-button-group {
            display: flex;
            gap: 12px;
        }

        .settings-btn {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn.active {
            background: #ffd60a;
            color: #000;
        }

        /* é£æ ¼åº“æ ·å¼ */
        .style-upload-area {
            margin-top: 10px;
        }

        .style-thumbnails {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .style-thumb {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .upload-btn {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .upload-btn input {
            display: none;
        }

        .style-status {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            height: 7.5%;
            min-height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
            position: relative;
            z-index: 10;
        }

        /* AIå›¾æ ‡ï¼ˆå·¦ä¸Šè§’ï¼‰ */
        .ai-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .ai-icon.active {
            background: linear-gradient(135deg, #ffd60a 0%, #ff9500 100%);
            transform: scale(1.1);
        }

        .ai-icon.is-listening {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 214, 10, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 214, 10, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 214, 10, 0);
            }
        }

        /* ç®€çº¦è®¾ç½®æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ */
        .settings-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-icon:active {
            transform: scale(0.85);
            opacity: 0.6;
        }

        /* å§¿åŠ¿å¼•å¯¼å›¾å±‚ */
        .pose-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .pose-overlay.active {
            opacity: 0.8;
            animation: breathe 3s infinite ease-in-out;
        }

        .pose-path {
            fill: none;
            stroke: rgba(255, 255, 255, 0.8);
            stroke-width: 2;
            stroke-dasharray: 10 5;
            stroke-linecap: round;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }

        @keyframes breathe {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 0.9;
            }
        }

        /* å˜ç„¦æ§åˆ¶æŒ‰é’® */
        .zoom-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: #ffd60a;
            transform: scale(1.1);
            font-weight: 800;
        }

        /* å–æ™¯å™¨ - å 85% */
        .viewfinder {
            height: 85%;
            position: relative;
            background: #222;
            margin: 0 10px;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .feedback {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            padding: 14px 28px;
            border-radius: 16px;
            color: #fff;
            font-size: 15px;
            text-align: center;
            white-space: nowrap;
            max-width: calc(100% - 40px);
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .feedback.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* åº•éƒ¨æ  */
        .bottom-bar {
            height: 7.5%;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #000;
            border: 3px solid #fff;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .capture-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: 4px solid #ffd60a;
        }

        .capture-btn:active {
            transform: scale(0.9);
        }

        .capture-btn:active::before {
            border-width: 5px;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        /* å“åº”å¼ï¼šç§»åŠ¨ç«¯ç›´æ¥å…¨å± */
        @media (max-width: 768px) {
            body {
                padding: 0;
                background: #000;
            }

            .phone-container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                padding: 0;
                box-shadow: none;
            }

            .phone-notch {
                display: none;
            }

            .app {
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <!-- æ‰‹æœºå¤–æ¡† -->
    <div class="phone-container">
        <!-- åˆ˜æµ· -->
        <div class="phone-notch"></div>

        <!-- Appä¸»ä½“ -->
        <div class="app">

            <!-- è®¾ç½®é¢æ¿ -->
            <div class="settings-panel" id="settingsPanel">
                <div class="settings-header">
                    <h2 class="settings-title">è®¾ç½®</h2>
                    <button class="close-btn" onclick="toggleSettings()">âœ•</button>
                </div>

                <div class="settings-item">
                    <label class="settings-label">è¯­éŸ³åé¦ˆ</label>
                    <div class="settings-toggle">
                        <span class="toggle-text">å¼€å¯è¯­éŸ³æç¤º</span>
                        <div class="toggle-switch active" onclick="toggleVoice(this)"></div>
                    </div>
                </div>

                <div class="settings-item">
                    <label class="settings-label">å›¾åƒè´¨é‡</label>
                    <div class="settings-button-group">
                        <button class="settings-btn" onclick="setQuality('1080P', this)">1080P</button>
                        <button class="settings-btn active" onclick="setQuality('2K', this)">2K</button>
                        <button class="settings-btn" onclick="setQuality('4K', this)">4K</button>
                    </div>
                </div>

                <div class="settings-item">
                    <label class="settings-label">ä¸ªäººé£æ ¼åº“</label>
                    <div class="style-upload-area">
                        <div class="style-thumbnails" id="styleThumbnails">
                            <!-- ä¸Šä¼ æŒ‰é’® -->
                            <label class="upload-btn">
                                <input type="file" id="styleUpload" multiple accept="image/*"
                                    onchange="handleStyleUpload(this)">
                                <span>+</span>
                            </label>
                            <!-- ç¼©ç•¥å›¾å°†æ’å…¥è¿™é‡Œ -->
                        </div>
                        <div class="style-status" id="styleStatus">ä¸Šä¼ å–œæ¬¢çš„ç…§ç‰‡ï¼ŒAI å°†å­¦ä¹ ä½ çš„é£æ ¼</div>
                    </div>
                </div>

                <div class="settings-item">
                    <label class="settings-label">å…³äº</label>
                    <div
                        style="padding: 14px 16px; background: rgba(255,255,255,0.05); border-radius: 12px; color: rgba(255,255,255,0.6); font-size: 13px;">
                        Focal v1.1<br>
                        æ™ºèƒ½æ‹ç…§ Â· è¯­éŸ³äº¤äº’ Â· é£æ ¼å­¦ä¹ 
                    </div>
                </div>
            </div>

            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <!-- AIå›¾æ ‡ï¼ˆå·¦ä¸Šè§’ï¼‰ -->
                <button class="ai-icon" id="aiIcon" onclick="toggleAI()">âœ¨</button>

                <!-- è®¾ç½®æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ -->
                <button class="settings-icon" onclick="toggleSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <circle cx="12" cy="5" r="1.5" />
                        <circle cx="12" cy="12" r="1.5" />
                        <circle cx="12" cy="19" r="1.5" />
                    </svg>
                </button>
            </div>

            <!-- å–æ™¯å™¨ -->
            <div class="viewfinder">
                <video id="video" autoplay playsinline></video>

                <div id="poseOverlay" class="pose-overlay">
                    <!-- SVG å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥ -->
                </div>



                <div class="feedback" id="feedback">ç‚¹å‡» âœ¨ å¯åŠ¨ focal</div>

                <!-- å˜ç„¦æ§åˆ¶ -->
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="setZoom(0.5, this)">0.5</button>
                    <button class="zoom-btn active" onclick="setZoom(1.0, this)">1</button>
                    <button class="zoom-btn" onclick="setZoom(1.25, this)">1.25</button>
                    <button class="zoom-btn" onclick="setZoom(1.5, this)">1.5</button>
                    <button class="zoom-btn" onclick="setZoom(2.0, this)">2</button>
                </div>
            </div>

            <!-- åº•éƒ¨æ  -->
            <div class="bottom-bar">
                <button class="icon-btn">ğŸ–¼ï¸</button>
                <button class="capture-btn" onclick="capture()"></button>
                <button class="icon-btn" onclick="flipCamera()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // åº•éƒ¨æç¤ºè‡ªåŠ¨æ¶ˆå¤±
        (function () {
            function hideFeedback() {
                setTimeout(() => {
                    const feedback = document.getElementById('feedback');
                    if (feedback) {
                        console.log('éšè—åº•éƒ¨æç¤º...');
                        feedback.classList.add('fade-out');
                    }
                }, 1500);
            }

            // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideFeedback);
            } else {
                hideFeedback();
            }
        })();

        // è®¾ç½®é¢æ¿åˆ‡æ¢
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('active');
        }

        // å›¾åƒè´¨é‡åˆ‡æ¢
        function setQuality(quality, btn) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.settings-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            console.log('å›¾åƒè´¨é‡å·²è®¾ç½®ä¸º:', quality);
        }

        // é£æ ¼ç…§ç‰‡ä¸Šä¼ ä¸å­¦ä¹ 
        async function handleStyleUpload(input) {
            const files = input.files;
            if (!files.length) return;

            const thumbnailsContainer = document.getElementById('styleThumbnails');
            const statusDiv = document.getElementById('styleStatus');
            const uploadBtn = thumbnailsContainer.querySelector('.upload-btn');

            statusDiv.textContent = 'æ­£åœ¨åˆ†æä½ çš„é£æ ¼...';

            const imagePromises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // åˆ›å»ºç¼©ç•¥å›¾
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'style-thumb';
                        thumbnailsContainer.insertBefore(img, uploadBtn);

                        // è¿”å› base64 (å»æ‰å‰ç¼€)
                        resolve(e.target.result.split(',')[1]);
                    };
                    reader.readAsDataURL(file);
                });
            });

            try {
                const base64Images = await Promise.all(imagePromises);

                // è°ƒç”¨åç«¯å­¦ä¹ é£æ ¼
                const response = await fetch(`${API_BASE}/learn_style`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: base64Images })
                });

                const result = await response.json();
                if (result.success) {
                    statusDiv.textContent = `å·²å­¦ä¹ é£æ ¼: ${result.style_profile}`;
                    statusDiv.style.color = '#ffd60a';
                } else {
                    statusDiv.textContent = 'å­¦ä¹ å¤±è´¥ï¼Œè¯·é‡è¯•';
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                statusDiv.textContent = 'ä¸Šä¼ å‡ºé”™';
            }
        }

        // å˜ç„¦æ§åˆ¶ï¼ˆæŒ‰é’®ï¼‰
        let currentZoom = 1.0;

        function setZoom(factor, btn) {
            currentZoom = factor;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // åº”ç”¨CSSç¼©æ”¾
            const video = document.getElementById('video');
            if (video) {
                video.style.transform = `scale(${currentZoom}) scaleX(-1)`;
                video.style.transformOrigin = 'center center';
            }
        }

        // ç¿»è½¬æ‘„åƒå¤´
        let facingMode = 'user';
        async function flipCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode, width: 720, height: 1280 }
                });
                document.getElementById('video').srcObject = stream;
            } catch (e) {
                updateFeedback('âš ï¸ è¯·å…è®¸æ‘„åƒå¤´æƒé™');
            }
        }

        // ==================== Focal AI Agent æ ¸å¿ƒæ¨¡å— ====================
        // æµç¨‹: å”¤é†’æ„ŸçŸ¥ â†’ å¯¼æ¼”å†³ç­– â†’ ARåˆå§‹åŒ– â†’ å®æ—¶å¼•å¯¼ â†’ å®Œç¾æ‹æ‘„

        const API_BASE = 'http://localhost:8000';  // åç«¯ API åœ°å€

        // ==================== AR å§¿åŠ¿å¼•å¯¼èµ„æº ====================
        const POSE_PATHS = {
            // è‡ªæ‹/è€¶
            "selfie_smile": "M150,100 Q180,100 180,130 Q180,160 150,160 Q120,160 120,130 Q120,100 150,100 M150,160 L150,300 M150,200 L100,250 M150,200 L200,180 L220,140 M150,300 L120,450 M150,300 L180,450",

            // é…·/æ’å…œ
            "standing_cool": "M150,100 Q180,100 180,130 Q180,160 150,160 Q120,160 120,130 Q120,100 150,100 M150,160 L140,300 M140,200 L110,250 M140,200 L180,250 M140,300 L130,450 M140,300 L160,450",

            // é€šç”¨
            "default": "M150,80 Q190,80 190,120 Q190,160 150,160 Q110,160 110,120 Q110,80 150,80 M150,160 L150,300 M150,220 L90,260 M150,220 L210,260 M150,300 L110,480 M150,300 L190,480"
        };


        // ==================== A. å”¤é†’ä¸æ„ŸçŸ¥ (Wake & Sense) ====================

        const FocalAgent = {
            isActive: false,           // Agent æ˜¯å¦æ¿€æ´»
            isAnalyzing: false,        // æ˜¯å¦æ­£åœ¨åˆ†æ
            analysisInterval: null,    // åˆ†æå®šæ—¶å™¨
            currentScene: null,        // å½“å‰åœºæ™¯
            currentPose: null,         // å½“å‰æ¨èå§¿åŠ¿
            voiceEnabled: true,        // è¯­éŸ³å¼•å¯¼å¼€å…³
            analysisFrequency: 3000,   // åˆ†æé¢‘ç‡ (ms)
            canvas: null,              // æˆªå›¾ç”»å¸ƒ
            ctx: null,                 // ç”»å¸ƒä¸Šä¸‹æ–‡
            recognition: null,         // è¯­éŸ³è¯†åˆ«å¯¹è±¡
            userSpeechBuffer: '',     // è¯­éŸ³ç¼“å†²åŒº
            isRecording: false,        // æ˜¯å¦æ­£åœ¨å½•éŸ³
            silenceTimer: null,        // é™éŸ³æäº¤å®šæ—¶å™¨

            // åˆå§‹åŒ– Agent
            init() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.initSpeechRecognition();
                console.log('ğŸš€ Focal Agent åˆå§‹åŒ–å®Œæˆ');
            },

            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API');
                    return;
                }

                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'zh-CN';

                this.recognition.onstart = () => {
                    this.isRecording = true;
                    const aiIcon = document.getElementById('aiIcon');
                    if (aiIcon) aiIcon.classList.add('is-listening');
                    console.log('ğŸ™ï¸ è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
                };

                this.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            this.userSpeechBuffer += event.results[i][0].transcript;

                            // [Fix] ä»…åœ¨æœ‰å†…å®¹æ—¶æ‰“å°ï¼Œé¿å…ç©ºç™½æ—¥å¿—é€ æˆçš„å›°æƒ‘
                            if (this.userSpeechBuffer.trim()) {
                                console.log('ğŸ—£ï¸ æœ€ç»ˆç»“æœ:', this.userSpeechBuffer);
                                showFeedback(`â€œ${this.userSpeechBuffer}â€`, 1000);
                                this.handleSpeechInput();
                            }
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    // å½“ç”¨æˆ·è¯´è¯æ—¶ï¼Œæ˜¾ç¤ºå®æ—¶é¢„è§ˆ
                    if (interimTranscript.length > 0) {
                        const feedback = document.getElementById('feedback');
                        if (feedback) {
                            feedback.textContent = `å¬åˆ°äº†: ${interimTranscript}...`;
                            feedback.classList.remove('fade-out');
                        }

                        // æ‰“æ–­é€»è¾‘ï¼šåœæ­¢ AI è¯´è¯
                        if (speechSynthesis.speaking) {
                            speechSynthesis.cancel();
                        }
                    }
                };

                this.recognition.onerror = (event) => {
                    console.error('ğŸ¤ è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                    if (event.error === 'no-speech') return;
                    this.isRecording = false;
                };

                this.recognition.onend = () => {
                    this.isRecording = false;
                    const aiIcon = document.getElementById('aiIcon');
                    if (aiIcon) aiIcon.classList.remove('is-listening');

                    // å¦‚æœ Agent ä»ç„¶æ¿€æ´»ï¼Œåˆ™é‡å¯è¯†åˆ«ï¼ˆå®ç°æŒç»­ç›‘å¬ï¼‰
                    if (this.isActive) {
                        setTimeout(() => this.startVoiceRecognition(), 500);
                    }
                };
            },

            // ==================== AR å§¿åŠ¿å¼•å¯¼ ====================

            updatePoseGuide(poseId) {
                const overlay = document.getElementById('poseOverlay');
                if (!overlay) return;

                // æŸ¥æ‰¾è·¯å¾„ï¼Œæ²¡æœ‰åˆ™ç”¨ default
                const pathData = POSE_PATHS[poseId] || POSE_PATHS["default"];

                // ç”Ÿæˆ SVG
                const svgContent = `
                    <svg viewBox="0 0 300 600" preserveAspectRatio="xMidYMid meet" style="width:100%; height:100%;">
                        <path d="${pathData}" class="pose-path" vector-effect="non-scaling-stroke"/>
                    </svg>
                `;

                overlay.innerHTML = svgContent;
                overlay.classList.add('active');

                // è‡ªåŠ¨æ·¡å‡ºé€»è¾‘ (å¯é€‰)
                /*
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 8000);
                */
            },



            // å¤„ç†è¯­éŸ³è¾“å…¥ï¼šæ£€æµ‹åˆ°æœ‰æ•ˆè¾“å…¥åè§¦å‘åˆ†æ
            handleSpeechInput() {
                if (this.userSpeechBuffer.trim().length > 0) {
                    clearTimeout(this.silenceTimer);
                    this.silenceTimer = setTimeout(() => {
                        console.log('ğŸš¦ è§¦å‘ç»¼åˆåˆ†æè¯·æ±‚...');
                        this.senseAndDecide(this.userSpeechBuffer);
                        this.userSpeechBuffer = ''; // å‘é€åæ¸…ç©º
                    }, 800);
                }
            },

            // å¼€å¯è¯­éŸ³ç›‘å¬
            startVoiceRecognition() {
                if (this.recognition && !this.isRecording) {
                    try {
                        this.recognition.start();
                    } catch (e) {
                        console.warn('è¯­éŸ³å¯åŠ¨è­¦å‘Š:', e);
                    }
                }
            },

            // åœæ­¢è¯­éŸ³ç›‘å¬
            stopVoiceRecognition() {
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                }
            },

            // å”¤é†’ Agentï¼ˆç‚¹å‡»âœ¨å›¾æ ‡æ—¶è§¦å‘ï¼‰
            async wake() {
                if (this.isActive) {
                    this.sleep();
                    return;
                }

                this.isActive = true;
                console.log('âœ¨ Focal Agent å·²å”¤é†’');
                showFeedback('focal æ­£åœ¨åˆ†æåœºæ™¯...');

                // ç«‹å³è¿›è¡Œç¬¬ä¸€æ¬¡åˆ†æ
                await this.senseAndDecide();

                // å¯åŠ¨æŒç»­æ„ŸçŸ¥å¾ªç¯
                this.startGuidanceLoop();

                // å¯åŠ¨è¯­éŸ³ç›‘å¬
                this.startVoiceRecognition();
            },

            // ä¼‘çœ  Agent - å®Œå…¨åœæ­¢ AI åˆ†æå’Œè¯­éŸ³
            sleep() {
                this.isActive = false;
                this.isAnalyzing = false;

                // 1. åœæ­¢å¾ªç¯é€»è¾‘
                this.stopGuidanceLoop();

                // 2. åœæ­¢è¯­éŸ³è¯†åˆ« (æ ¸å¿ƒï¼šåˆ‡æ–­è€³æœµ)
                this.stopVoiceRecognition();

                // 3. åœæ­¢è¯­éŸ³è¾“å‡º (æ ¸å¿ƒï¼šåˆ‡æ–­å˜´å·´)
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }

                // 4. æ¸…ç† UI è¦†ç›–å±‚
                const aiIcon = document.getElementById('aiIcon');
                if (aiIcon) aiIcon.classList.remove('is-listening');

                // éšè— AR å¼•å¯¼çº¿
                this.updatePoseGuide("none"); // ä¼ å…¥æ— æ•ˆ ID å¯æ¸…é™¤ï¼Œæˆ–è€…è°ƒç”¨ hidePoseGuide å¦‚æœæœ‰çš„è¯
                // ç”±äº updatePoseGuide åªæ˜¯åŠ å†…å®¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¸…ç†é€»è¾‘ã€‚
                // æ—¢ç„¶å®šä¹‰äº† hidePoseGuide (ä¹‹å‰æ²¡åŠ è¿› FocalAgent, åªæ˜¯å…¨å±€å‡½æ•°? ä¸, æˆ‘ä¸Šä¸€æ­¥åŠ çš„æ˜¯ updatePoseGuide)
                // è®©æˆ‘ç›´æ¥æ“ä½œ DOM ç§»é™¤ active class å§ï¼Œæˆ–è€…ä¼ å…¥ null
                const overlay = document.getElementById('poseOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    overlay.innerHTML = '';
                }

                console.log('ğŸ˜´ Focal Agent å·²ä¼‘çœ  - éº¦å…‹é£å·²é‡Šæ”¾');
                showFeedback('focal å·²å…³é—­', 1000);
            },

            // æ„ŸçŸ¥å½“å‰ç”»é¢
            async captureFrame() {
                const video = document.getElementById('video');
                if (!video || !video.videoWidth) return null;

                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                const scale = 0.35;  // [ä¼˜åŒ–] è¿›ä¸€æ­¥é™ä½åˆ†è¾¨ç‡ä»¥åŠ å¿«ä¸Šä¼ é€Ÿåº¦ (Race Mode Ready)
                this.canvas.width = video.videoWidth * scale;
                this.canvas.height = video.videoHeight * scale;

                // ç»˜åˆ¶å½“å‰å¸§
                this.ctx.drawImage(video, 0, 0, this.canvas.width, this.canvas.height);

                // è½¬æ¢ä¸º base64 (ä½¿ç”¨ webp æ ¼å¼ï¼Œä½“ç§¯æ›´å°)
                // [ä¼˜åŒ–] è´¨é‡é™è‡³ 0.6ï¼Œè§†è§‰è¯†åˆ«ä¸å—å½±å“ä½†ä½“ç§¯å‡åŠ
                const imageData = this.canvas.toDataURL('image/webp', 0.6);
                return imageData.split(',')[1];  // è¿”å›çº¯ base64
            },

            // ==================== B. å¯¼æ¼”å†³ç­– (The Director) ====================

            async senseAndDecide(userMessage = null) {
                if (this.isAnalyzing) return null;

                this.isAnalyzing = true;

                try {
                    // æ„ŸçŸ¥ï¼šæ•è·å½“å‰ç”»é¢
                    const imageBase64 = await this.captureFrame();
                    if (!imageBase64) {
                        console.warn('âš ï¸ æ— æ³•æ•è·ç”»é¢');
                        return null;
                    }

                    console.log('ğŸ“· å·²æ•è·ç”»é¢ï¼Œå‘é€è‡³ Director...');

                    // å†³ç­–ï¼šè°ƒç”¨ AI Director API
                    const response = await fetch(`${API_BASE}/analyze_image`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_base64: imageBase64,
                            image_format: 'webp',
                            user_message: userMessage || this.userSpeechBuffer
                        })
                    });

                    // æ¸…ç©ºå·²å‘é€çš„ç¼“å†²åŒºï¼ˆå¦‚æœæ˜¯é€šè¿‡è½®è¯¢å‘é€çš„ï¼‰
                    if (!userMessage) this.userSpeechBuffer = '';

                    if (!response.ok) {
                        throw new Error(`API é”™è¯¯: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        console.log('ğŸ¬ Director å†³ç­–:', result.data);
                        return this.processDirectorDecision(result.data);
                    }

                } catch (error) {
                    console.error('âŒ Director è°ƒç”¨å¤±è´¥:', error);
                    showFeedback('âš ï¸ AI è¿æ¥å¤±è´¥', 2000);
                } finally {
                    this.isAnalyzing = false;
                }

                return null;
            },

            // å¤„ç† Director çš„å†³ç­–
            processDirectorDecision(decision) {
                const { detected_scene, scene_analysis, recommended_pose_id, voice_feedback, action } = decision;

                // æ›´æ–°å½“å‰çŠ¶æ€
                // æ›´æ–°å½“å‰çŠ¶æ€
                this.currentScene = detected_scene;
                this.currentPose = recommended_pose_id;

                // C. AR åˆå§‹åŒ– - æ˜¾ç¤ºå¼•å¯¼ä¿¡æ¯
                // this.setupARGuidance(decision);

                // æ˜¾ç¤ºå§¿åŠ¿å¼•å¯¼çº¿ (NEW)
                if (recommended_pose_id) {
                    this.updatePoseGuide(recommended_pose_id);
                }

                // D. æ ¹æ® action æ‰§è¡Œå¯¹åº”æ“ä½œ
                switch (action) {
                    case 'capture':
                        // ç«‹å³æ‹ç…§
                        if (!this.voiceEnabled) showFeedback('ğŸ“¸ å‡†å¤‡æ‹æ‘„...', 1000);
                        setTimeout(() => this.capturePhoto(), 1000);
                        break;

                    case 'change_pose':
                    case 'talk':
                    case 'continue':
                    default:
                        // å¦‚æœæ²¡æœ‰è¯­éŸ³ï¼Œæ‰‹åŠ¨æ˜¾ç¤ºåé¦ˆ
                        if (!this.voiceEnabled && voice_feedback) {
                            showFeedback(voice_feedback, 2000);
                        }
                        break;
                }

                // è¯­éŸ³åé¦ˆï¼ˆåŒæ—¶æ˜¾ç¤ºå­—å¹•ï¼‰
                if (this.voiceEnabled && voice_feedback) {
                    this.speak(voice_feedback);
                }

                return decision;
            },

            // ==================== C. AR åˆå§‹åŒ– (AR Setup) ====================

            setupARGuidance(decision) {
                // æ›´æ–°åœºæ™¯ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦æ˜¾ç¤ºåœ¨ UI ä¸Šï¼‰
                if (decision.scene_analysis) {
                    console.log('ğŸŒ„ åœºæ™¯åˆ†æ:', decision.scene_analysis);
                }

                // æ›´æ–°æ¨èå§¿åŠ¿ï¼ˆå¦‚æœéœ€è¦æ˜¾ç¤ºåœ¨ UI ä¸Šï¼‰
                if (decision.recommended_pose_id) {
                    console.log('ğŸ’ƒ æ¨èå§¿åŠ¿:', decision.recommended_pose_id);
                }
            },

            // ==================== D. å®æ—¶å¼•å¯¼é—­ç¯ (The Guidance Loop) ====================

            startGuidanceLoop() {
                if (this.analysisInterval) return;  // é¿å…é‡å¤å¯åŠ¨

                console.log('ğŸ”„ å¯åŠ¨å®æ—¶å¼•å¯¼å¾ªç¯');

                this.analysisInterval = setInterval(async () => {
                    if (this.isActive && !this.isAnalyzing) {
                        await this.senseAndDecide();
                    }
                }, this.analysisFrequency);
            },

            stopGuidanceLoop() {
                if (this.analysisInterval) {
                    clearInterval(this.analysisInterval);
                    this.analysisInterval = null;
                    console.log('â¹ï¸ åœæ­¢å®æ—¶å¼•å¯¼å¾ªç¯');
                }
            },

            // ==================== E. å®Œç¾æ‹æ‘„ (Capture) ====================

            async capturePhoto() {
                const video = document.getElementById('video');
                if (!video) return;

                // åˆ›å»ºå…¨åˆ†è¾¨ç‡æˆªå›¾
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const ctx = captureCanvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                // è·å–å›¾ç‰‡æ•°æ®
                const imageData = captureCanvas.toDataURL('image/jpeg', 0.95);

                // æ˜¾ç¤ºæ‹æ‘„æˆåŠŸ
                showFeedback('ğŸ“¸ æ‹æ‘„æˆåŠŸï¼', 2000);

                // è¯­éŸ³åé¦ˆ
                if (this.voiceEnabled) {
                    this.speak('å¾ˆå¥½ï¼Œè¿™å¼ å¾ˆæ£’ï¼');
                }

                // ä¸‹è½½å›¾ç‰‡
                const link = document.createElement('a');
                link.download = `focal_${Date.now()}.jpg`;
                link.href = imageData;
                link.click();

                console.log('ğŸ“· ç…§ç‰‡å·²ä¿å­˜');
            },

            // è¯­éŸ³åé¦ˆï¼ˆä½¿ç”¨ Web Speech APIï¼Œå…ƒæ°”æ´»æ³¼çš„å£°éŸ³ï¼‰
            // åŒæ—¶æ˜¾ç¤ºå­—å¹•ï¼Œè¯­éŸ³å’Œæ–‡å­—å®Œå…¨åŒæ­¥
            speak(text) {
                if (!this.voiceEnabled) return;

                // æ˜¾ç¤ºå­—å¹•ï¼ˆä¸è¯­éŸ³åŒæ­¥ï¼‰
                showFeedback(text, 0);  // æŒç»­æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨æ¶ˆå¤±

                if ('speechSynthesis' in window) {
                    // å–æ¶ˆä¹‹å‰çš„è¯­éŸ³ï¼Œé¿å…é‡å 
                    speechSynthesis.cancel();

                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 1.4;    // æ›´å¿«çš„è¯­é€Ÿ
                    utterance.pitch = 1.3;   // è¾ƒé«˜çš„éŸ³è°ƒï¼Œæ›´å…ƒæ°”
                    utterance.volume = 0.9;

                    // é€‰æ‹©å¥³å£°ï¼ˆæ›´æ´»æ³¼ï¼‰
                    const voices = speechSynthesis.getVoices();
                    const femaleVoice = voices.find(v =>
                        v.lang.includes('zh') && (v.name.includes('Female') || v.name.includes('å¥³') || v.name.includes('Ting'))
                    );
                    if (femaleVoice) utterance.voice = femaleVoice;

                    // è¯­éŸ³ç»“æŸåéšè—å­—å¹•
                    utterance.onend = () => {
                        setTimeout(() => {
                            const feedback = document.getElementById('feedback');
                            if (feedback) feedback.classList.add('fade-out');
                        }, 300);
                    };

                    speechSynthesis.speak(utterance);
                } else {
                    // æ²¡æœ‰è¯­éŸ³APIæ—¶ï¼Œ0.8ç§’åæ¶ˆå¤±
                    setTimeout(() => {
                        const feedback = document.getElementById('feedback');
                        if (feedback) feedback.classList.add('fade-out');
                    }, 800);
                }
            }
        };

        // ==================== UI äº¤äº’å¢å¼º ====================

        // æ˜¾ç¤ºåé¦ˆä¿¡æ¯ï¼ˆæ”¯æŒé•¿æ–‡æœ¬åˆ†æ®µæ˜¾ç¤ºï¼‰
        let feedbackQueue = [];
        let isShowingFeedback = false;

        function showFeedback(text, duration = 800) {
            const feedback = document.getElementById('feedback');
            if (!feedback) return;

            // æŒ‰æ ‡ç‚¹ç¬¦å·åˆ†å‰²é•¿æ–‡æœ¬
            const maxLength = 20;  // æ¯æ®µæœ€å¤§å­—ç¬¦æ•°
            if (text.length > maxLength) {
                // æŒ‰é€—å·ã€å¥å·ç­‰åˆ†å‰²
                const segments = text.split(/([ï¼Œ,ã€‚ï¼ï¼Ÿã€])/);
                let currentSegment = '';
                const parts = [];

                for (let i = 0; i < segments.length; i++) {
                    currentSegment += segments[i];
                    if (currentSegment.length >= maxLength || i === segments.length - 1) {
                        if (currentSegment.trim()) {
                            parts.push(currentSegment.trim());
                        }
                        currentSegment = '';
                    }
                }

                // åŠ å…¥é˜Ÿåˆ—ä¾æ¬¡æ˜¾ç¤º
                if (parts.length > 1) {
                    parts.forEach((part, index) => {
                        feedbackQueue.push({ text: part, duration: duration || 1200 });
                    });
                    processQueue();
                    return;
                }
            }

            // ç›´æ¥æ˜¾ç¤º
            feedback.textContent = text;
            feedback.classList.remove('fade-out');

            if (duration > 0) {
                setTimeout(() => {
                    feedback.classList.add('fade-out');
                }, duration);
            }
        }

        function processQueue() {
            if (isShowingFeedback || feedbackQueue.length === 0) return;

            isShowingFeedback = true;
            const item = feedbackQueue.shift();
            const feedback = document.getElementById('feedback');

            feedback.textContent = item.text;
            feedback.classList.remove('fade-out');

            setTimeout(() => {
                feedback.classList.add('fade-out');
                setTimeout(() => {
                    isShowingFeedback = false;
                    processQueue();
                }, 500);
            }, item.duration);
        }

        // é‡å†™ toggleAI ä»¥é›†æˆ Agent
        function toggleAI() {
            const icon = document.getElementById('aiIcon');
            icon.classList.toggle('active');

            if (icon.classList.contains('active')) {
                FocalAgent.wake();
            } else {
                FocalAgent.sleep();
            }
        }

        // é‡å†™ capture ä»¥ä½¿ç”¨ Agent
        function capture() {
            if (FocalAgent.isActive) {
                FocalAgent.capturePhoto();
            } else {
                showFeedback('ğŸ“¸ æ‹æ‘„æˆåŠŸï¼', 2000);
            }
        }

        // è¯­éŸ³å¼€å…³
        function toggleVoice(element) {
            element.classList.toggle('active');
            FocalAgent.voiceEnabled = element.classList.contains('active');
            showFeedback(FocalAgent.voiceEnabled ? 'è¯­éŸ³å¼•å¯¼å·²å¼€å¯' : 'è¯­éŸ³å¼•å¯¼å·²å…³é—­', 1000);
        }

        // åˆå§‹åŒ–
        FocalAgent.init();
        startCamera();
    </script>
</body>

</html>